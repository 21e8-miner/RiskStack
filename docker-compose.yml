services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: riskstack
      POSTGRES_PASSWORD: riskstack
      POSTGRES_DB: riskstack
    ports: [ "5432:5432" ]
    volumes: [ "pgdata:/var/lib/postgresql/data" ]

  redis:
    image: redis:7-alpine
    ports: [ "6379:6379" ]

  backend:
    build: .
    env_file: .env
    depends_on: [ db, redis ]
    expose: [ "8000" ]
    command: [ "bash", "-lc", "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000" ]

  worker:
    build: .
    env_file: .env
    depends_on: [ db, redis ]
    command: [ "bash", "-lc", "celery -A app.tasks.celery_app.celery worker -l info" ]

  beat:
    build: .
    env_file: .env
    depends_on: [ db, redis ]
    command: [ "bash", "-lc", "celery -A app.tasks.celery_app.celery beat -l info" ]

  frontend:
    build: ./frontend
    depends_on: [ backend ]
    expose: [ "80" ]

  nginx:
    image: nginx:1.27-alpine
    depends_on: [ frontend, backend ]
    ports: [ "8080:80" ]
    volumes:
      - ./infra/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

volumes:
  pgdata:
